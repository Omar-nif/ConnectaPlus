// ======================================================================
// Prisma Client generator
// - Genera el cliente tipado para usar Prisma en Node/TS.
// ======================================================================
generator client {
  provider = "prisma-client-js"
}

// ======================================================================
// Datasource (PostgreSQL)
// - Lee la cadena de conexión de la variable de entorno DATABASE_URL.
// ======================================================================
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ======================================================================
// Modelo: User
// - Representa cuentas de usuario en la app.
// - Relación 1:N con Group (un usuario puede ser dueño de varios grupos).
// ======================================================================
model User {
  id        Int      @id @default(autoincrement()) // PK autoincremental
  name      String?                                 // Nombre opcional
  email     String   @unique                        // Correo único
  password  String                                  // Hash de contraseña
  createdAt DateTime @default(now())                // Fecha de creación

  groups Group[]
  // Relación con pagos
  payments Payment[]

}

// ======================================================================
// Modelo: Group
// - Grupo creado por un dueño (ownerId).
// - Datos derivados del preset (platformKey/name/planKey, precios, slots).
// - Credenciales se muestran borrosas en FE hasta “pago completado” (lógica FE).
// ======================================================================
model Group {
  id             Int      @id @default(autoincrement())
  ownerId        Int
  owner          User     @relation(fields: [ownerId], references: [id])
  serviceId      Int?     // ← NUEVO: foreign key opcional
  service        Service? @relation(fields: [serviceId], references: [id]) // ← NUEVO: relación
  platformKey    String
  platformName   String
  planKey        String?
  basePriceMXN   Int
  slots          Int
  pricePerMember Int
  credentials    String
  notes          String?
  status         String   @default("active")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  payments       Payment[]

  @@index([ownerId])
  @@index([serviceId]) // ← NUEVO: índice para serviceId
}

// ======================================================================
// Modelo: Payment
// ======================================================================
model Payment {
  id                    Int      @id @default(autoincrement())
  userId                Int
  groupId               Int?
  stripePaymentIntentId String   @unique
  amount                Int // en centavos (ej: 1000 = $10.00)
  currency              String   @default("mxn")
  status                String   @default("pending") // "pending" | "succeeded" | "failed"
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relaciones
  user  User   @relation(fields: [userId], references: [id])
  group Group? @relation(fields: [groupId], references: [id])

  @@index([userId])
  @@index([groupId])
}

// ======================================================================
// Modelo: Services
// ======================================================================
model Service {
  id           Int      @id @default(autoincrement())
  slug         String   @unique
  name         String
  description  String
  category     String   // 'peliculas-series' | 'programas' | 'musica' | 'juegos'
  basePriceMXN Int?
  slots        Int?
  plans        Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  groups       Group[]

  @@map("services")
}